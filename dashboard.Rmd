---
title: Health Dashboard
output:
  flexdashboard::flex_dashboard:
    orientation: column
---

```{r setup, include=FALSE}


## Health dashboard, front end for the dashboard, calculations are available in the data import R script
## 


source("libraries.R")

## Input parameters that can be modified
## Can be updated into a ShinyApp for better data interaction

lwr_lim <- ymd("2022-08-01")
upr_lim <- ymd("2023-10-01")
w_mod <- 5
ord <- 1
target_fp <- 15
target_bm <- 69

## Script call 
source("data_import.R")

## Calculating the predicted values
tf_bm <- lwr_lim + ((target_bm - model_bodymass$coefficients[[1]]) / (model_bodymass$coefficients[[2]]))*7
tf_fp <- lwr_lim + (target_fp - model_fatperc$coefficients[[1]]) /  (model_fatperc$coefficients[[2]])*7

## Removing unused variables 
rm(list = c("dr","dr_1","dr_2","dr_3","dr_4","dr_7","t_interval",
            "model_data","ord","model_bodymass","model_fatperc"))

```


Data presentation {data-icon="fa-table"}
=====================================     

Column {data-width=500}
-----------------------------------------------------------------------

### Purpose {data-height=100}

An overview of data related to weight loss through fitness tracking, with a focus on monitoring key performance indicators.  
Using a linear model, forecast the anticipated duration for reaching a desired value by analyzing data from the preceding five weeks, for the Fat percentage and Body Mass graphs.

### KPI 

```{r}

## KPI values on the top left corner 
valueBox(value = paste(round(last(df_clean[!is.na(df_clean$body_mass),]$body_mass),2),
                       " kg and ", 
                       round(last(df_clean[!is.na(df_clean$fat_perc),]$fat_perc),2),
                       " fat [%]"),
         icon = "ion-ios-body")

```

### Data Overview table {data-height=250}

```{r}

## Creating the recap table of data for data visualisation
recap_table <- df_clean %>%
  mutate(delta_body_mass = body_mass - lag(body_mass, default = first(body_mass)),
         delta_lean_mass = lean_mass - lag(lean_mass, default = first(lean_mass)),
         delta_fat_mass = fat_mass - lag(fat_mass, default = first(fat_mass)),
         date = lwr_lim + weeks(date), empty = ""
         )  %>% 
  filter(!is.na(delta_body_mass)) %>% 
  select( date,body_mass,lean_mass,fat_mass,delta_body_mass,delta_lean_mass,delta_fat_mass) %>% 
  arrange(desc(date))


## Adding conditional colors to the table for better data interpretation
recap_table %>%
  kbl(
    digits = 2,
    align = "c",
    booktabs = T,
    linesep = "",
    col.names = c("date","BodyMass","LeanMass","FatMass","d_BM","d_LM","d_FM")) %>% 
  kable_styling( position = "center") %>%
  add_header_above(c(" ", "absolute value" = 3,"delta" = 3)) %>% 
  column_spec(5, color = if_else(recap_table$delta_body_mass >= 0 , "#808080","#009FFF")) %>% 
  column_spec(6, color = if_else(recap_table$delta_lean_mass < 0  , "#ec2F4B","#009FFF")) %>% 
  column_spec(7, color = if_else(recap_table$delta_fat_mass  > 0  , "#ec2F4B","#009FFF")) 

```

### Consumed Kcal {data-height=250}

```{r}

## Interactive table displaying using ggplotly
ggplotly(
  df_clean %>%
    ggplot(aes(x = lwr_lim + weeks(date))) +
    geom_point(aes(y = kcal),na.rm = T,col = "blue") +
    geom_line(aes(y = kcal),na.rm = T,col = "blue") +
    scale_y_continuous(n.breaks = 10,limits = c(1700,2300)) +
    scale_x_date(date_labels = "%b %y", date_breaks = "1 month",) +
    geom_hline(yintercept = c(1800,2000,2200) ,linetype = 2 , col = "red")+
    theme(axis.text.x = element_text(angle = 45))+
    labs( y = "kcal", x = "Date")
)

```




Column {data-width=500}
-----------------------------------------------------------------------

### Fat percentage

```{r }

## Interactive table displaying using ggplotly
ggplotly(
  df_clean %>% 
    ggplot(aes(x = lwr_lim + weeks(date))) +
    geom_point(aes(y = fat_perc),na.rm = T,col = "red", size= 0.75) +
    geom_line(aes(y = fat_perc),na.rm = T,col = "red") +
    geom_line(aes(y = fatperc_pred), na.rm = T, col = "grey", linetype = 3) +
    scale_y_continuous(n.breaks = 10,limits = c(target_fp-1,23)) +
    geom_hline(yintercept = target_fp ,linetype = 2 , col = "grey") +
    scale_x_date(date_labels = "%b %y", date_breaks = "1 month") + 
    geom_point(aes(tf_fp,target_fp), shape = 3, color = "red")+
    theme(axis.text.x = element_text(angle = 45))+
    labs( y = "Fat percentage", x = "Date")
)

```

### Body Mass

```{r }

## Interactive table displaying using ggplotly
ggplotly(
  df_clean %>%   
    ggplot(aes(x = lwr_lim + weeks(date))) +
    geom_point(aes(y = body_mass),na.rm = T, col = "red", size= 0.75) +
    geom_line(aes(y = body_mass),na.rm = T, col = "red") +
    geom_line(aes(y = bodymass_pred), col = "grey",na.rm = T, linetype = 3) +
    scale_y_continuous(n.breaks = 20,limits = c(target_bm-1,83)) +
    geom_hline(yintercept = target_bm, linetype = 2, col = "grey") +
    scale_x_date(date_labels = "%b %y", date_breaks = "1 month" ) +
    geom_point(aes(tf_bm,target_bm), shape = 3, color = "red")+
    theme(axis.text.x = element_text(angle = 45))+
    labs( y = "Body Mass", x = "Date")
  
)

```

Other graphs {data-icon="fa-signal"}
===================================== 

### Lean Body Mass

```{r}

## Interactive table displaying using ggplotly
ggplotly(
  df_clean %>% 
    ggplot(aes(x = lwr_lim + weeks(date))) +
    geom_point(aes(y = lean_mass),na.rm = T, col = "red") +
    geom_line(aes(y = lean_mass),na.rm = T, col = "red") +
    scale_y_continuous(n.breaks = 10,limits = c(60,64)) +
    scale_x_date(date_labels = "%b %y", date_breaks = "1 month") +
    labs( y = "Lean Body Mass [kg]",  x = "Date" )
)

```

 

